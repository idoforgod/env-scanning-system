# Environmental Scanning Workflow Definition
# Orchestrator가 참조하는 선언적 워크플로우 정의
# 기존 17단계 워크플로우 전체 유지

version: "2.1"
name: "env-scanning-workflow"
description: "환경스캐닝 자동화 워크플로우 (17단계 전체)"

# 모드 설정
default_mode: marathon  # 기본 모드를 Marathon으로 설정
skip_human_review: true  # Human Review 기본 생략 (--with-review로 포함)

modes:
  fast:
    description: "핵심 소스만 빠르게 스캔"
    marathon_enabled: false

  marathon:  # 기본 모드
    description: "심층 확장 스캔 + 신규 소스 탐험"
    marathon_enabled: true

    # Stage 1: 기존 소스 스캔 (가변 시간)
    stage1:
      description: "기존 DB 로딩 및 등록된 소스 스캔"
      crawlers:
        - naver-news-crawler
        - global-news-crawler
        - google-news-crawler

    # Stage 2: 신규 소스 탐험 (잔여 시간 전체 강제 배정)
    stage2:
      description: "완전히 새로운 소스 발굴"
      forced_allocation: true  # 잔여 시간 전체 강제 배정
      agents:
        - id: gap-analyzer
          order: 1
          parallel: false
          time_allocation: fixed_5min
          model: haiku
        - id: frontier-explorer
          order: 2
          parallel: true
          time_allocation: 55%
          model: sonnet
        - id: citation-chaser
          order: 2
          parallel: true
          time_allocation: 35%
          model: sonnet
        - id: rapid-validator
          order: 3
          parallel: false
          time_allocation: 10%
          model: haiku

# Phase 정의
phases:
  # ═══════════════════════════════════════════════════════════════════
  # Phase 1: Research (정보 수집) - 4단계
  # ═══════════════════════════════════════════════════════════════════
  - id: phase1
    name: "Research"
    description: "정보 수집 및 원시 데이터 생성"

    steps:
      - id: step1
        agent: archive-loader
        description: "기존 신호 DB 로드"
        parallel: false
        input:
          database: "signals/database.json"
        output:
          summary: "context/archive-summary-{date}.json"
          dedup_index: "context/dedup-index-{date}.json"
        token_estimate: 800

      - id: step2
        agent: multi-source-scanner
        description: "다중 소스 스캐닝"
        parallel: false
        marathon_mode:
          enabled: "{mode.marathon_enabled}"
          stage1_output: "data/{date}/raw/stage1-signals.json"
          stage2_output: "data/{date}/raw/exploration-signals.json"
        input:
          sources: "config/regular-sources.json"
          previous: "context/dedup-index-{date}.json"
        output:
          signals: "data/{date}/raw/scanned-signals.json"
        token_estimate: 2000

      - id: step3
        agent: dedup-filter
        description: "중복 신호 필터링"
        parallel: false
        input:
          signals: "data/{date}/raw/scanned-signals.json"
          database: "signals/database.json"
          index: "context/dedup-index-{date}.json"
        output:
          filtered: "data/{date}/filtered/filtered-signals.json"
          new_index: "context/dedup-index-{date}.json"
        token_estimate: 600

      - id: step4
        type: human_review
        description: "[Human Review] 필터링 결과 검토"
        skip_condition: "--skip-human"
        command: "/env-scan:review-filter"
        token_estimate: 0

    gate:
      id: gate1
      name: "Phase 1 Quality Gate"
      checks:
        - name: "filtered signals exist"
          file: "data/{date}/filtered/filtered-signals.json"
          condition: "exists"
        - name: "signal count > 0"
          file: "data/{date}/filtered/filtered-signals.json"
          condition: "json_count > 0"
          path: "$.signals"
        - name: "dedup index valid"
          file: "context/dedup-index-{date}.json"
          condition: "exists"

  # ═══════════════════════════════════════════════════════════════════
  # Phase 2: Planning (분석 및 구조화) - 7단계
  # ═══════════════════════════════════════════════════════════════════
  - id: phase2
    name: "Planning"
    description: "신호 분석, 분류, 우선순위 산정"

    steps:
      - id: step5
        agent: signal-classifier
        description: "STEEPS 분류 및 pSRT 계산"
        parallel: false
        input:
          signals: "data/{date}/filtered/filtered-signals.json"
        output:
          structured: "data/{date}/structured/structured-signals.json"
          psrt: "data/{date}/analysis/pSRT-scores.json"
        token_estimate: 1200

      - id: step6
        agent: confidence-evaluator
        description: "pSRT 심층 평가 및 할루시네이션 플래그 생성"
        parallel: false
        input:
          psrt: "data/{date}/analysis/pSRT-scores.json"
        output:
          evaluation: "data/{date}/analysis/confidence-evaluation.json"
        token_estimate: 600

      - id: step7
        agent: hallucination-detector
        description: "할루시네이션 검증"
        parallel: false
        mandatory: true  # 필수 - 실패 시 워크플로우 중단
        input:
          psrt: "data/{date}/analysis/pSRT-scores.json"
          evaluation: "data/{date}/analysis/confidence-evaluation.json"
          structured: "data/{date}/structured/structured-signals.json"
        output:
          report: "data/{date}/analysis/hallucination-report.json"
        token_estimate: 800

      - id: step8
        agent: pipeline-validator
        description: "데이터 동기화 검증"
        parallel: false
        input:
          structured: "data/{date}/structured/structured-signals.json"
          psrt: "data/{date}/analysis/pSRT-scores.json"
        output:
          validation: "data/{date}/analysis/validation-report.json"
        token_estimate: 400

      - id: step9_10_parallel
        agents:
          - impact-analyzer
          - priority-ranker
        description: "영향 분석 + 우선순위 산정 (병렬)"
        parallel: true
        input:
          structured: "data/{date}/structured/structured-signals.json"
          hallucination: "data/{date}/analysis/hallucination-report.json"
        output:
          impact: "data/{date}/analysis/impact-assessment.json"
          priority: "data/{date}/analysis/priority-ranked.json"
        token_estimate: 1500  # 병렬이므로 합산

      - id: step11
        type: human_review
        description: "[Human Review] 분석 결과 검토"
        skip_condition: "--skip-human"
        command: "/env-scan:review-analysis"
        token_estimate: 0

    gate:
      id: gate2
      name: "Phase 2 Quality Gate"
      checks:
        - name: "hallucination report exists"
          file: "data/{date}/analysis/hallucination-report.json"
          condition: "exists"
          mandatory: true
        - name: "validation report exists"
          file: "data/{date}/analysis/validation-report.json"
          condition: "exists"
        - name: "pSRT scores exist"
          file: "data/{date}/analysis/pSRT-scores.json"
          condition: "exists"
        - name: "priority ranking exists"
          file: "data/{date}/analysis/priority-ranked.json"
          condition: "exists"
        - name: "signal count consistency"
          condition: "signal_count_match"
          files:
            - "data/{date}/filtered/filtered-signals.json"
            - "data/{date}/structured/structured-signals.json"
          tolerance: 0.05  # 5% 허용

  # ═══════════════════════════════════════════════════════════════════
  # Phase 3: Implementation (보고서 생성) - 6단계
  # ═══════════════════════════════════════════════════════════════════
  - id: phase3
    name: "Implementation"
    description: "DB 업데이트, 보고서 생성, 아카이빙"

    steps:
      - id: step12_13_parallel
        agents:
          - db-updater
          - report-generator
        description: "DB 업데이트 + 보고서 생성 (병렬)"
        parallel: true
        input:
          structured: "data/{date}/structured/structured-signals.json"
          analysis: "data/{date}/analysis/"
        output:
          database: "signals/database.json"
          snapshot: "signals/snapshots/database-{date}.json"
          report: "data/{date}/reports/environmental-scan-{date}.md"
        token_estimate: 1200

      - id: step14
        agent: archive-notifier
        description: "아카이빙 및 완료 처리"
        parallel: false
        input:
          all_outputs: "data/{date}/"
        output:
          archive_report: "logs/archive-notifier-report-{date}.md"
          status: "logs/workflow-status.json"
        token_estimate: 500

      - id: step15_16_parallel
        agents:
          - source-evolver
          - file-organizer
        description: "소스 진화 + 파일 정리 (선택적, 병렬)"
        parallel: true
        optional: true  # 실패해도 워크플로우 계속
        input:
          pending_sources: "config/evolution/pending-sources.json"
          data_folder: "data/{date}/"
        output:
          evolution_log: "config/evolution/evolution-log.json"
        token_estimate: 400

      - id: step17
        type: human_approval
        description: "[Human Approval] 최종 승인"
        skip_condition: "--skip-human"
        command: "/env-scan:approve 또는 /env-scan:revision"
        token_estimate: 0

    gate:
      id: gate3
      name: "Phase 3 Quality Gate"
      checks:
        - name: "report generated"
          file: "data/{date}/reports/environmental-scan-{date}.md"
          condition: "exists"
        - name: "database updated"
          file: "signals/database.json"
          condition: "updated_today"
        - name: "archive complete"
          file: "logs/archive-notifier-report-{date}.md"
          condition: "exists"

# 에이전트 메타데이터 (17개 + Stage 2 에이전트 4개)
agents:
  # Phase 1
  archive-loader:
    subagent_type: "archive-loader"
    max_retries: 2
    timeout: 300  # 5분
    skippable: false

  multi-source-scanner:
    subagent_type: "multi-source-scanner"
    max_retries: 1
    timeout: 10800  # 3시간 (Marathon)
    skippable: false

  dedup-filter:
    subagent_type: "dedup-filter"
    max_retries: 2
    timeout: 600  # 10분
    skippable: false

  # Marathon Mode Stage 2 전용 에이전트
  gap-analyzer:
    subagent_type: "gap-analyzer"
    max_retries: 1
    timeout: 300  # 5분
    skippable: false
    model: haiku
    description: "STEEPS/지역/언어 갭 분석"

  frontier-explorer:
    subagent_type: "frontier-explorer"
    max_retries: 1
    timeout: 5400  # 90분
    skippable: false
    model: opus
    description: "미개척 영역 탐험 (지역/언어/플랫폼)"

  citation-chaser:
    subagent_type: "citation-chaser"
    max_retries: 1
    timeout: 3600  # 60분
    skippable: false
    model: sonnet
    description: "인용 체인 역추적"

  rapid-validator:
    subagent_type: "rapid-validator"
    max_retries: 1
    timeout: 1200  # 20분
    skippable: false
    model: haiku
    description: "발견 소스 실시간 검증 및 승격"

  # Phase 2
  signal-classifier:
    subagent_type: "signal-classifier"
    max_retries: 2
    timeout: 900  # 15분
    skippable: false
    model: opus

  confidence-evaluator:
    subagent_type: "confidence-evaluator"
    max_retries: 2
    timeout: 600
    skippable: false
    model: sonnet

  hallucination-detector:
    subagent_type: "hallucination-detector"
    max_retries: 2
    timeout: 600
    skippable: false
    mandatory: true
    model: opus

  pipeline-validator:
    subagent_type: "pipeline-validator"
    max_retries: 2
    timeout: 300
    skippable: false
    model: sonnet

  impact-analyzer:
    subagent_type: "impact-analyzer"
    max_retries: 2
    timeout: 900
    skippable: false
    model: opus

  priority-ranker:
    subagent_type: "priority-ranker"
    max_retries: 2
    timeout: 600
    skippable: false

  # Phase 3
  db-updater:
    subagent_type: "db-updater"
    max_retries: 3
    timeout: 600
    skippable: false

  report-generator:
    subagent_type: "report-generator"
    max_retries: 2
    timeout: 900
    skippable: false
    model: opus

  archive-notifier:
    subagent_type: "archive-notifier"
    max_retries: 2
    timeout: 600
    skippable: false

  source-evolver:
    subagent_type: "source-evolver"
    max_retries: 1
    timeout: 300
    skippable: true  # 실패해도 계속
    model: sonnet

  file-organizer:
    subagent_type: "general-purpose"
    max_retries: 1
    timeout: 300
    skippable: true  # 실패해도 계속

# 토큰 예산 (17단계 기준)
token_budget:
  total_limit: 100000
  phase1_limit: 3500   # 4단계
  phase2_limit: 4500   # 7단계
  phase3_limit: 2500   # 6단계
  overhead: 1000       # Orchestrator 자체 사용
  estimated_total: 11500  # 기존 26,000 대비 56% 절감

# 체크포인트 설정
checkpoint:
  enabled: true
  interval: "after_each_step"
  location: "logs/checkpoint-{date}.json"
  auto_resume: true

# 알림 설정
notifications:
  on_phase_complete: true
  on_gate_failure: true
  on_workflow_complete: true
  on_error: true
